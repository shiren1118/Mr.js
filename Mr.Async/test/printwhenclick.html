<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../Mr.async.js"></script>
		<script type="text/javascript" src="parser.js"></script>
		<script type="text/javascript" src="ExpressionVisitor.js"></script>
		<script type="text/javascript">
			function d(callback){
				var de = Mr.Deferred();
				setTimeout(function(){
					var result = Math.random();
					if(typeof callback == 'function'){
						callback(result);
					}
					de.resolve(result);
				}, 2000);
				return de;
			}
			var code = UglifyJS.parse('var c = 1, a = $await(d()), e = 2;console.log(a);var b = $await(d());console.log(b);');

			window.onload = function(){

				window.EV = Mr.EV.extend({
					visitForLoop : function(expression, base){
						this._recodeLoop(expression[2], expression[4], null, expression[1], expression[3]);
						return expression;
					},
					visitDoWhileLoop : function(expression, base){
						this._recodeLoop(expression[1], expression[2], expression[2]);
						return expression;
					},
					visitWhileLoop : function(expression, base){
						this._recodeLoop(expression[1], expression[2]);
						return expression;
					},
					visitStatement : function(expression, base){
						var key = expression[0];
						switch(key){
							case 'break':
								this._append('return Mr.BREAK;');
								return expression;
							case 'continue':
								this._append('return Mr.CONTINUE;');
								return expression;
							case 'stat':
								if(expression[1][0] == 'call' && expression[1][1][1] == '$await'){
									this._visitAwait(expression[1]);
									return expression;
								}
								break;
						}
						return base(expression);
					},
					visitVariable : function(expression, base){
						
						var normal = [];
						var awaits = [];

						for(var i = 0, len = expression[1].length ; i < len ; i++){
							var item = expression[1][i];
							if(item[1][0] == 'call' && item[1][1][1] == '$await'){
								awaits.push(item);
							}else{
								normal.push(item);
							}
						}

						if(normal.length > 0){
							this._append('var ');
							for(var i = 0, len = normal.length ; i < len ; i++){
								this.visitVariableAssignment(normal[i]);
								if(i != len - 1){
									this._append(',');
								}
							}
							this.onLineEnd();
						}


						for(var i = 0, len = awaits.length ; i < len ; i++){
							this._visitAwait(awaits[i]);
						}

						return expression;
					},
					onVisitEnd : function(){
						for(var i = this._lastAppend.length ; i >= 0 ; i--){
							this._append(this._lastAppend[i]);
						}
					},
					// only two type will be converted.
					// 1. var
					// 2. just method call
					_visitAwait : function(expression){
						var justMethodCall = expression[0] == 'call';
						var variableName = justMethodCall ? null : expression[0];
						var parameters = justMethodCall ? expression[2] : expression[1][2];
						
						if(parameters.length == 0){
							throw 'no parameter in $await method.';
						}

						this._append('Mr.when(');
						for(var i = 0, len = parameters.length; i < len ; i++){
							if(0){
								throw 'Must be a Mr.Deferred object';
							}
							this.visit(parameters[i]);
						}
						this._append(').done(function(');
						if(parameters.length > 1){
							this._append('var ' + variableName + '=[].slice.call(arguments);');
						}else{
							this._append(variableName);
						}
						this._append('){');
						this._lastAppend.push('});');

						return expression;
					},
					_lastAppend : [],
					_recodeLoop : function(condition, block, innerBefore, outerBefore, after){
						if(condition == null || block == null) 
							throw 'condition or block is null';
						
						if(outerBefore != null){
							this.visit(outerBefore);
						}

						this._append('Mr.asynIterator(Mr.infinite(), function(cnt){');

						if(after != null){
							this._append('if(cnt != 1){');
							this.visit(after);
							this._append(';');
							this._append('}');
						}

						if(innerBefore != null){
							this._append('if(cnt == 1){');
							this.visit(innerBefore);
							this._append('}');
						}

						this._append('if(');
						var conditional = this.visit(condition);
						this._append('){');
						var block = this.visit(block);
						
						this._append('this.next();');
						this._append('}else{');
						this._append('return Mr.BREAK;');
						this._append('}');
						this._append('});');
					}
				});

				window.EV_OLD = Mr.EV.extend();
			};
		</script>
	</head>
	<body style="height:1000px;">
		<ul id="output">
			
		</ul>
	</body>
</html>