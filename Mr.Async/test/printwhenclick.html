<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../Mr.async.js"></script>
		<script type="text/javascript" src="parser.js"></script>
		<script type="text/javascript" src="ExpressionVisitor.js"></script>
		<script type="text/javascript">
			function d(callback){
				var i = 0, de = Mr.Deferred();
				setTimeout(function(){
					var result = ++i;
					if(typeof callback == 'function'){
						callback(result);
					}
					de.resolve(result);
				}, 2000);
				return de;
			}

			var code = UglifyJS.parse('var num=$await(d);console.log(num);');

			window.onload = function(){

				window.EV = Mr.EV.extend({
					visitForLoop : function(expression, base){
						this._recodeLoop(expression[2], expression[4], null, expression[1], expression[3]);
						return expression;
					},
					visitDoWhileLoop : function(expression, base){
						this._recodeLoop(expression[1], expression[2], expression[2]);
						return expression;
					},
					visitWhileLoop : function(expression, base){
						this._recodeLoop(expression[1], expression[2]);
						return expression;
					},
					visitStatement : function(expression, base){
						var key = expression[0];
						switch(key){
							case 'break':
								this._append('return Mr.BREAK;');
								return expression;
							case 'continue':
								this._append('return Mr.CONTINUE;');
								return expression;
						}
						return base(expression);
					},
					visitMethodCall : function(expression, base){
						var methodName = expression[1][1];
						if(methodName == '$await'){
							console.log(111);
						}
						return base(expression);
					},
					_recodeLoop : function(condition, block, innerBefore, outerBefore, after){
						if(condition == null || block == null) 
							throw 'condition or block is null';
						
						if(outerBefore != null){
							this.visit(outerBefore);
						}

						this._append('Mr.asynIterator(Mr.infinite(), function(cnt){');

						if(after != null){
							this._append('if(cnt != 1){');
							this.visit(after);
							this._append(';');
							this._append('}');
						}

						if(innerBefore != null){
							this._append('if(cnt == 1){');
							this.visit(innerBefore);
							this._append('}');
						}

						this._append('if(');
						var conditional = this.visit(condition);
						this._append('){');
						var block = this.visit(block);
						
						this._append('this.next();');
						this._append('}else{');
						this._append('return Mr.BREAK;');
						this._append('}');
						this._append('});');
					}
				});

				window.EV_OLD = Mr.EV.extend();
			};
		</script>
	</head>
	<body style="height:1000px;">
		<ul id="output">
			
		</ul>
	</body>
</html>